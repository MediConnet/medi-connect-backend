generator client {
  provider      = "prisma-client-js"
  output        = "../src/generated/prisma"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
  engineType    = "library" // <-- Cambia "adapter" por "library"
}

datasource db {
  provider = "postgresql"
}

model appointments {
  id                String              @id @db.Uuid
  patient_id        String?             @db.Uuid
  branch_id         String?             @db.Uuid
  provider_id       String?             @db.Uuid
  clinic_id         String?             @db.Uuid
  scheduled_for     DateTime?           @db.Timestamp(6)
  status            String?             @db.VarChar(255)
  reason            String?
  payment_method    enum_payment_method @default(CASH)
  cost              Decimal             @default(0) @db.Decimal(10, 2)
  is_paid           Boolean?            @default(false)
  reception_status  String?             @db.VarChar(50)
  reception_notes   String?
  provider_branches provider_branches?  @relation(fields: [branch_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  patients          patients?           @relation(fields: [patient_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  providers         providers?          @relation(fields: [provider_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  clinics            clinics?            @relation(fields: [clinic_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  payments          payments[]
  reviews           reviews[]
  medical_history   medical_history[]
}

model cities {
  id                String              @id @db.Uuid
  name              String              @db.VarChar(255)
  state             String?             @db.VarChar(255)
  country           String?             @db.VarChar(255)
  provider_branches provider_branches[]
}

model medical_history {
  id                   String        @id @db.Uuid
  patient_id           String?       @db.Uuid
  provider_id          String?       @db.Uuid
  appointment_id       String?       @db.Uuid
  doctor_name_snapshot String?       @db.VarChar(255)
  specialty_snapshot   String?       @db.VarChar(255)
  diagnosis            String?
  date                 DateTime?     @db.Timestamp(6)
  treatment            String?
  indications          String?
  observations         String?
  created_at           DateTime?     @default(now()) @db.Timestamp(6)
  updated_at           DateTime?     @default(now()) @db.Timestamp(6)
  patients             patients?     @relation(fields: [patient_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  providers            providers?    @relation(fields: [provider_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  appointments         appointments? @relation(fields: [appointment_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model notifications {
  id         String           @id @db.Uuid
  patient_id String           @db.Uuid
  type       enum_notif_types
  title      String           @db.VarChar(255)
  body       String
  is_read    Boolean?         @default(false)
  data       Json?
  created_at DateTime?        @default(now()) @db.Timestamp(6)
  patients   patients         @relation(fields: [patient_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([patient_id, created_at(sort: Desc)], map: "idx_notifications_patient_created")
}

model patient_favorites {
  id                String             @id @db.Uuid
  patient_id        String?            @db.Uuid
  branch_id         String?            @db.Uuid
  created_at        DateTime?          @default(now()) @db.Timestamp(6)
  provider_branches provider_branches? @relation(fields: [branch_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  patients          patients?          @relation(fields: [patient_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model patients {
  id                String              @id @db.Uuid
  user_id           String?             @db.Uuid
  full_name         String              @db.VarChar(255)
  identification    String?             @db.VarChar(255)
  phone             String?             @db.VarChar(20)
  birth_date        DateTime?           @db.Date
  address_text      String?
  appointments      appointments[]
  medical_history   medical_history[]
  notifications     notifications[]
  patient_favorites patient_favorites[]
  users             users?              @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  reviews           reviews[]
}

model payments {
  id                       String        @id @db.Uuid
  appointment_id           String?       @db.Uuid
  payout_id                String?       @db.Uuid
  stripe_payment_intent_id String?       @db.VarChar(255)
  amount_total             Decimal?      @db.Decimal
  platform_fee             Decimal?      @db.Decimal
  provider_amount          Decimal?      @db.Decimal
  status                   String?       @db.VarChar(255)
  created_at               DateTime?     @default(now()) @db.Timestamp(6)
  appointments             appointments? @relation(fields: [appointment_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  payouts                  payouts?      @relation(fields: [payout_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model payouts {
  id               String     @id @db.Uuid
  provider_id      String?    @db.Uuid
  total_amount     Decimal?   @db.Decimal
  currency         String?    @default("USD") @db.VarChar(3)
  status           String?    @db.VarChar(255)
  reference_number String?    @db.VarChar(255)
  period_start     DateTime?  @db.Timestamp(6)
  period_end       DateTime?  @db.Timestamp(6)
  created_at       DateTime?  @default(now()) @db.Timestamp(6)
  payments         payments[]
  providers        providers? @relation(fields: [provider_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model provider_ads {
  id               String     @id @db.Uuid
  provider_id      String?    @db.Uuid
  badge_text       String?    @db.VarChar(255)
  title            String?    @db.VarChar(255)
  subtitle         String?    @db.VarChar(255)
  image_url        String?    @db.VarChar(255)
  action_text      String?    @db.VarChar(255)
  bg_color_hex     String?    @db.VarChar(7)
  accent_color_hex String?    @db.VarChar(7)
  target_screen    String?    @db.VarChar(255)
  target_id        String?    @db.VarChar(255)
  start_date       DateTime?  @db.Timestamp(6)
  end_date         DateTime?  @db.Timestamp(6)
  is_active        Boolean?   @default(true)
  priority_order   Int?
  providers        providers? @relation(fields: [provider_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model provider_bank_details {
  id                    String     @id @db.Uuid
  provider_id           String?    @db.Uuid
  bank_name             String?    @db.VarChar(255)
  account_number        String?    @db.VarChar(255)
  account_type          String?    @db.VarChar(50)
  account_holder_name   String?    @db.VarChar(255)
  holder_identification String?    @db.VarChar(255)
  is_verified           Boolean?   @default(false)
  updated_at            DateTime?  @default(now()) @db.Timestamp(6)
  providers             providers? @relation(fields: [provider_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model provider_branches {
  id                 String               @id @db.Uuid
  provider_id        String?              @db.Uuid
  city_id            String?              @db.Uuid
  name               String?              @db.VarChar(255)
  description        String?
  address_text       String?
  latitude           Float?
  longitude          Float?
  phone_contact      String?              @db.VarChar(20)
  email_contact      String?              @db.VarChar(255)
  image_url          String?              @db.VarChar(255)
  opening_hours_text String?
  is_24h             Boolean?             @default(false)
  has_delivery       Boolean?             @default(false)
  rating_cache       Float?               @default(0)
  is_main            Boolean?             @default(false)
  is_active          Boolean?             @default(false)
  consultation_fee   Decimal?             @db.Decimal(10, 2)
  payment_methods    String[]
  appointments       appointments[]
  patient_favorites  patient_favorites[]
  cities             cities?              @relation(fields: [city_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  providers          providers?           @relation(fields: [provider_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  provider_schedules provider_schedules[]
  reviews            reviews[]
}

model provider_catalog {
  id           String     @id @db.Uuid
  provider_id  String?    @db.Uuid
  type         String?    @db.VarChar(255)
  name         String?    @db.VarChar(255)
  description  String?
  price        Decimal?   @db.Decimal
  is_available Boolean?   @default(true)
  image_url    String?    @db.VarChar(255)
  providers    providers? @relation(fields: [provider_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model provider_schedules {
  id                String             @id @db.Uuid
  branch_id         String?            @db.Uuid
  day_of_week       Int?
  start_time        DateTime?          @db.Time(6)
  end_time          DateTime?          @db.Time(6)
  is_active         Boolean?
  provider_branches provider_branches? @relation(fields: [branch_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model providers {
  id                    String                  @id @db.Uuid
  user_id               String?                 @db.Uuid
  category_id           Int?
  commercial_name       String?                 @db.VarChar(255)
  logo_url              String?                 @db.VarChar(255)
  description           String?
  years_of_experience   Int?                    @default(0)
  verification_status   String?                 @db.VarChar(255)
  commission_percentage Decimal?                @db.Decimal
  appointments          appointments[]
  medical_history       medical_history[]
  payouts               payouts[]
  specialties           specialties[]
  provider_ads          provider_ads[]
  provider_bank_details provider_bank_details[]
  provider_branches     provider_branches[]
  provider_catalog      provider_catalog[]
  service_categories    service_categories?     @relation(fields: [category_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  users                 users?                  @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model reviews {
  id                String             @id @db.Uuid
  patient_id        String?            @db.Uuid
  branch_id         String?            @db.Uuid
  appointment_id    String?            @db.Uuid
  rating            Int?
  comment           String?
  created_at        DateTime?          @default(now()) @db.Timestamp(6)
  appointments      appointments?      @relation(fields: [appointment_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  provider_branches provider_branches? @relation(fields: [branch_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  patients          patients?          @relation(fields: [patient_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model service_categories {
  id                Int         @id @default(autoincrement())
  name              String      @db.VarChar(255)
  slug              String      @db.VarChar(255)
  default_color_hex String?     @db.VarChar(7)
  allows_booking    Boolean?    @default(true)
  providers         providers[]
}

model sessions {
  id          String    @id @db.Uuid
  user_id     String?   @db.Uuid
  token       String    @db.VarChar(255)
  device_info String?   @db.VarChar(255)
  expires_at  DateTime  @db.Timestamp(6)
  created_at  DateTime? @default(now()) @db.Timestamp(6)
  users       users?    @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model specialties {
  id          String  @id @db.Uuid
  name        String  @db.VarChar(255)
  description String?
  color_hex   String? @db.VarChar(7)

  created_at DateTime?   @default(now()) @db.Timestamp(6)
  updated_at DateTime?   @default(now()) @db.Timestamp(6)
  providers  providers[]
}

model users {
  id                  String           @id @db.Uuid
  email               String           @db.VarChar(255)
  password_hash       String           @db.VarChar(255)
  role                enum_roles?
  profile_picture_url String?          @db.VarChar(255)
  is_active           Boolean?         @default(true)
  created_at          DateTime?        @default(now()) @db.Timestamp(6)
  patients            patients[]
  providers           providers[]
  sessions            sessions[]
  clinics             clinics[]
  clinic_doctors      clinic_doctors[]
}

enum enum_appt_status {
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum enum_notif_types {
  REMINDER
  SYSTEM
  BOOKING
  cita
  laboratorio
  farmacia
  ambulancia
  insumo
  sistema
}

enum enum_roles {
  admin
  user
  provider
  patient
}

enum enum_verification {
  PENDING
  APPROVED
  REJECTED
}

enum enum_payment_method {
  CASH
  CARD
}

// ============================================
// CLINICS MODELS
// ============================================

model clinics {
  id                  String              @id @db.Uuid
  user_id             String?             @db.Uuid
  name                String              @db.VarChar(255)
  logo_url            String?             @db.VarChar(500)
  address             String
  phone               String              @db.VarChar(20)
  whatsapp            String              @db.VarChar(20)
  description         String?
  is_active           Boolean?           @default(true)
  created_at          DateTime?          @default(now()) @db.Timestamp(6)
  updated_at          DateTime?          @default(now()) @db.Timestamp(6)
  users               users?              @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  clinic_specialties  clinic_specialties[]
  clinic_schedules    clinic_schedules[]
  clinic_doctors      clinic_doctors[]
  doctor_invitations  doctor_invitations[]
  doctor_schedules    doctor_schedules[]
  appointments        appointments[]
  
  @@unique([user_id])
}

model clinic_specialties {
  id         String    @id @db.Uuid
  clinic_id String?   @db.Uuid
  specialty  String    @db.VarChar(255)
  created_at DateTime? @default(now()) @db.Timestamp(6)
  clinics    clinics?  @relation(fields: [clinic_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  
  @@unique([clinic_id, specialty])
}

model clinic_schedules {
  id          String    @id @db.Uuid
  clinic_id   String?   @db.Uuid
  day_of_week Int
  enabled     Boolean?  @default(false)
  start_time  DateTime? @db.Time(6)
  end_time    DateTime? @db.Time(6)
  created_at  DateTime? @default(now()) @db.Timestamp(6)
  updated_at  DateTime? @default(now()) @db.Timestamp(6)
  clinics     clinics?  @relation(fields: [clinic_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  
  @@unique([clinic_id, day_of_week])
}

model clinic_doctors {
  id                    String              @id @db.Uuid
  clinic_id             String?             @db.Uuid
  user_id               String?             @db.Uuid
  email                 String              @db.VarChar(255)
  name                  String?             @db.VarChar(255)
  specialty             String?             @db.VarChar(255)
  office_number         String?             @db.VarChar(50)
  profile_image_url     String?             @db.VarChar(500)
  phone                 String?             @db.VarChar(20)
  whatsapp              String?             @db.VarChar(20)
  is_active              Boolean?           @default(true)
  is_invited            Boolean?           @default(true)
  invitation_token      String?             @db.VarChar(255)
  invitation_expires_at DateTime?           @db.Timestamp(6)
  created_at            DateTime?           @default(now()) @db.Timestamp(6)
  updated_at            DateTime?           @default(now()) @db.Timestamp(6)
  clinics               clinics?            @relation(fields: [clinic_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users                 users?               @relation(fields: [user_id], references: [id], onDelete: SetNull, onUpdate: NoAction)
  doctor_schedules      doctor_schedules[]
  
  @@unique([clinic_id, email])
  @@unique([invitation_token])
}

model doctor_invitations {
  id              String    @id @db.Uuid
  clinic_id       String?   @db.Uuid
  email           String    @db.VarChar(255)
  invitation_token String   @db.VarChar(255)
  expires_at      DateTime  @db.Timestamp(6)
  status          String?   @default("pending") @db.VarChar(50)
  created_at      DateTime? @default(now()) @db.Timestamp(6)
  clinics         clinics?  @relation(fields: [clinic_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  
  @@unique([invitation_token])
}

model doctor_schedules {
  id          String           @id @db.Uuid
  doctor_id   String?          @db.Uuid
  clinic_id   String?          @db.Uuid
  day_of_week Int
  enabled     Boolean?         @default(false)
  start_time  DateTime?        @db.Time(6)
  end_time    DateTime?        @db.Time(6)
  break_start DateTime?        @db.Time(6)
  break_end   DateTime?        @db.Time(6)
  created_at  DateTime?        @default(now()) @db.Timestamp(6)
  updated_at  DateTime?        @default(now()) @db.Timestamp(6)
  clinic_doctors clinic_doctors? @relation(fields: [doctor_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  clinics      clinics?         @relation(fields: [clinic_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  
  @@unique([doctor_id, clinic_id, day_of_week])
}
