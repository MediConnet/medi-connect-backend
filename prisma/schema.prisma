generator client {
  provider      = "prisma-client-js"
  output        = "../src/generated/prisma"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  // url moved to prisma.config.ts in Prisma 7
}

model appointments {
  id                String              @id @db.Uuid
  patient_id        String?             @db.Uuid
  branch_id         String?             @db.Uuid
  provider_id       String?             @db.Uuid
  scheduled_for     DateTime?           @db.Timestamp(6)
  status            String?             @db.VarChar(255)
  reason            String?
  is_paid           Boolean?            @default(false)
  cost              Decimal             @default(0) @db.Decimal(10, 2)
  payment_method    enum_payment_method @default(CASH)
  clinic_id         String?             @db.Uuid
  reception_notes   String?
  reception_status  String?             @db.VarChar(50)
  provider_branches provider_branches?  @relation(fields: [branch_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  clinics           clinics?            @relation(fields: [clinic_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  patients          patients?           @relation(fields: [patient_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  providers         providers?          @relation(fields: [provider_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  medical_history   medical_history[]
  payments          payments[]
  reviews           reviews[]

  @@index([provider_id])
  @@index([patient_id])
  @@index([scheduled_for])
  @@index([status])
}

model cities {
  id                String              @id @db.Uuid
  name              String              @db.VarChar(255)
  state             String?             @db.VarChar(255)
  country           String?             @db.VarChar(255)
  provider_branches provider_branches[]
}

model medical_history {
  id                   String        @id @db.Uuid
  patient_id           String?       @db.Uuid
  provider_id          String?       @db.Uuid
  doctor_name_snapshot String?       @db.VarChar(255)
  specialty_snapshot   String?       @db.VarChar(255)
  diagnosis            String?
  date                 DateTime?     @db.Timestamp(6)
  treatment            String?
  indications          String?
  observations         String?
  created_at           DateTime?     @default(now()) @db.Timestamp(6)
  updated_at           DateTime?     @default(now()) @db.Timestamp(6)
  appointment_id       String?       @db.Uuid
  appointments         appointments? @relation(fields: [appointment_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  patients             patients?     @relation(fields: [patient_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  providers            providers?    @relation(fields: [provider_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model notifications {
  id         String           @id @db.Uuid
  patient_id String           @db.Uuid
  type       enum_notif_types
  title      String           @db.VarChar(255)
  body       String
  is_read    Boolean?         @default(false)
  data       Json?
  created_at DateTime?        @default(now()) @db.Timestamp(6)
  patients   patients         @relation(fields: [patient_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([patient_id, created_at(sort: Desc)], map: "idx_notifications_patient_created")
}

model clinic_notifications {
  id         String    @id @db.Uuid
  clinic_id  String?   @db.Uuid
  type       String    @db.VarChar(50)
  title      String    @db.VarChar(255)
  body       String
  is_read    Boolean?  @default(false)
  data       Json?
  created_at DateTime? @default(now()) @db.Timestamp(6)
  clinics    clinics?  @relation(fields: [clinic_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([clinic_id, created_at(sort: Desc)], map: "idx_clinic_notifications_clinic_created")
}

model patient_favorites {
  id                String             @id @db.Uuid
  patient_id        String?            @db.Uuid
  branch_id         String?            @db.Uuid
  created_at        DateTime?          @default(now()) @db.Timestamp(6)
  provider_branches provider_branches? @relation(fields: [branch_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  patients          patients?          @relation(fields: [patient_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model patients {
  id                String              @id @db.Uuid
  user_id           String?             @db.Uuid
  full_name         String              @db.VarChar(255)
  identification    String?             @db.VarChar(255)
  phone             String?             @db.VarChar(20)
  birth_date        DateTime?           @db.Date
  address_text      String?
  appointments      appointments[]
  medical_history   medical_history[]
  notifications     notifications[]
  patient_favorites patient_favorites[]
  users             users?              @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  reviews           reviews[]
}

model payments {
  id                       String        @id @db.Uuid
  appointment_id           String?       @db.Uuid
  payout_id                String?       @db.Uuid
  stripe_payment_intent_id String?       @db.VarChar(255)
  amount_total             Decimal?      @db.Decimal
  platform_fee             Decimal?      @db.Decimal
  provider_amount          Decimal?      @db.Decimal
  status                   String?       @db.VarChar(255)
  created_at               DateTime?     @default(now()) @db.Timestamp(6)
  appointments             appointments? @relation(fields: [appointment_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  payouts                  payouts?      @relation(fields: [payout_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model payouts {
  id               String     @id @db.Uuid
  provider_id      String?    @db.Uuid
  total_amount     Decimal?   @db.Decimal
  currency         String?    @default("USD") @db.VarChar(3)
  status           String?    @db.VarChar(255)
  reference_number String?    @db.VarChar(255)
  period_start     DateTime?  @db.Timestamp(6)
  period_end       DateTime?  @db.Timestamp(6)
  created_at       DateTime?  @default(now()) @db.Timestamp(6)
  payments         payments[]
  providers        providers? @relation(fields: [provider_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model provider_ads {
  id               String     @id @db.Uuid
  provider_id      String?    @db.Uuid
  badge_text       String?    @db.VarChar(255)
  title            String?    @db.VarChar(255)
  subtitle         String?    @db.VarChar(255)
  image_url        String?    @db.VarChar(255)
  action_text      String?    @db.VarChar(255)
  bg_color_hex     String?    @db.VarChar(7)
  accent_color_hex String?    @db.VarChar(7)
  target_screen    String?    @db.VarChar(255)
  target_id        String?    @db.VarChar(255)
  start_date       DateTime?  @db.Timestamp(6)
  end_date         DateTime?  @db.Timestamp(6)
  is_active        Boolean?   @default(true)
  priority_order   Int?
  status           ad_status  @default(PENDING)
  providers        providers? @relation(fields: [provider_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model provider_bank_details {
  id                    String     @id @db.Uuid
  provider_id           String?    @db.Uuid
  bank_name             String?    @db.VarChar(255)
  account_number        String?    @db.VarChar(255)
  account_type          String?    @db.VarChar(50)
  account_holder_name   String?    @db.VarChar(255)
  holder_identification String?    @db.VarChar(255)
  is_verified           Boolean?   @default(false)
  updated_at            DateTime?  @default(now()) @db.Timestamp(6)
  providers             providers? @relation(fields: [provider_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model provider_branches {
  id                 String               @id @db.Uuid
  provider_id        String?              @db.Uuid
  city_id            String?              @db.Uuid
  name               String?              @db.VarChar(255)
  description        String?
  address_text       String?
  latitude           Float?
  longitude          Float?
  phone_contact      String?              @db.VarChar(20)
  email_contact      String?              @db.VarChar(255)
  image_url          String?              @db.VarChar(255)
  opening_hours_text String?
  is_24h             Boolean?             @default(false)
  has_delivery       Boolean?             @default(false)
  rating_cache       Float?               @default(0)
  is_main            Boolean?             @default(false)
  is_active          Boolean?             @default(false)
  consultation_fee   Decimal?             @db.Decimal(10, 2)
  payment_methods    String[]
  appointments       appointments[]
  patient_favorites  patient_favorites[]
  cities             cities?              @relation(fields: [city_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  providers          providers?           @relation(fields: [provider_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  provider_schedules provider_schedules[]
  reviews            reviews[]
}

model provider_catalog {
  id           String     @id @db.Uuid
  provider_id  String?    @db.Uuid
  type         String?    @db.VarChar(255)
  name         String?    @db.VarChar(255)
  description  String?
  price        Decimal?   @db.Decimal
  is_available Boolean?   @default(true)
  image_url    String?    @db.VarChar(255)
  providers    providers? @relation(fields: [provider_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model provider_schedules {
  id                String             @id @db.Uuid
  branch_id         String?            @db.Uuid
  day_of_week       Int?
  start_time        DateTime?          @db.Time(6)
  end_time          DateTime?          @db.Time(6)
  is_active         Boolean?
  provider_branches provider_branches? @relation(fields: [branch_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model providers {
  id                    String                  @id @db.Uuid
  user_id               String?                 @db.Uuid
  category_id           Int?
  chain_id              String?                 @db.Uuid
  commercial_name       String?                 @db.VarChar(255)
  logo_url              String?                 @db.VarChar(255)
  description           String?
  verification_status   String?                 @db.VarChar(255)
  commission_percentage Decimal?                @db.Decimal
  years_of_experience   Int?                    @default(0)
  appointments          appointments[]
  medical_history       medical_history[]
  payouts               payouts[]
  provider_ads          provider_ads[]
  provider_bank_details provider_bank_details[]
  provider_branches     provider_branches[]
  provider_catalog      provider_catalog[]
  service_categories    service_categories?     @relation(fields: [category_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  users                 users?                  @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  specialties           specialties[]           @relation("providersTospecialties")
  pharmacy_chains       pharmacy_chains?        @relation(fields: [chain_id], references: [id], onDelete: SetNull, onUpdate: NoAction)

  @@index([chain_id])
}

model reviews {
  id                String             @id @db.Uuid
  patient_id        String?            @db.Uuid
  branch_id         String?            @db.Uuid
  appointment_id    String?            @db.Uuid
  rating            Int?
  comment           String?
  created_at        DateTime?          @default(now()) @db.Timestamp(6)
  appointments      appointments?      @relation(fields: [appointment_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  provider_branches provider_branches? @relation(fields: [branch_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  patients          patients?          @relation(fields: [patient_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model service_categories {
  id                Int         @id @default(autoincrement())
  name              String      @db.VarChar(255)
  slug              String      @db.VarChar(255)
  default_color_hex String?     @db.VarChar(7)
  allows_booking    Boolean?    @default(true)
  providers         providers[]
}

model sessions {
  id          String    @id @default(uuid()) @db.Uuid
  user_id     String?   @db.Uuid
  token       String    @db.Text
  device_info String?   @db.VarChar(255)
  expires_at  DateTime  @db.Timestamp(6)
  created_at  DateTime? @default(now()) @db.Timestamp(6)
  revoked_at  DateTime? @db.Timestamp(6)
  users       users?    @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model specialties {
  id          String      @id @db.Uuid
  name        String      @db.VarChar(255)
  description String?
  color_hex   String?     @db.VarChar(7)
  created_at  DateTime?   @default(now()) @db.Timestamp(6)
  updated_at  DateTime?   @default(now()) @db.Timestamp(6)
  providers   providers[] @relation("providersTospecialties")
}

model users {
  id                  String           @id @db.Uuid
  email               String           @db.VarChar(255)
  password_hash       String           @db.VarChar(255)
  role                enum_roles       @default(patient)
  profile_picture_url String?          @db.VarChar(255)
  is_active           Boolean?         @default(true)
  created_at          DateTime?        @default(now()) @db.Timestamp(6)
  clinic_doctors      clinic_doctors[]
  clinics             clinics?
  patients            patients[]
  providers           providers[]
  sessions            sessions[]
}

model clinics {
  id                   String                 @id @db.Uuid
  user_id              String?                @unique @db.Uuid
  name                 String                 @db.VarChar(255)
  logo_url             String?                @db.Text // ⭐ Cambiado a Text para soportar imágenes base64
  address              String
  phone                String                 @db.VarChar(20)
  whatsapp             String                 @db.VarChar(20)
  description          String?
  is_active            Boolean?               @default(true)
  created_at           DateTime?              @default(now()) @db.Timestamp(6)
  updated_at           DateTime?              @default(now()) @db.Timestamp(6)
  latitude             Decimal?               @db.Decimal(10, 8)
  longitude            Decimal?               @db.Decimal(11, 8)
  appointments         appointments[]
  clinic_doctors       clinic_doctors[]
  clinic_notifications clinic_notifications[]
  clinic_schedules     clinic_schedules[]
  clinic_specialties   clinic_specialties[]
  users                users?                 @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  doctor_invitations   doctor_invitations[]
  doctor_schedules     doctor_schedules[]
  reception_messages   reception_messages[]
  date_block_requests  date_block_requests[]
}

model clinic_specialties {
  id         String    @id @db.Uuid
  clinic_id  String?   @db.Uuid
  specialty  String    @db.VarChar(255)
  created_at DateTime? @default(now()) @db.Timestamp(6)
  clinics    clinics?  @relation(fields: [clinic_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([clinic_id, specialty])
}

model clinic_schedules {
  id          String    @id @db.Uuid
  clinic_id   String?   @db.Uuid
  day_of_week Int
  enabled     Boolean?  @default(false)
  start_time  DateTime? @db.Time(6)
  end_time    DateTime? @db.Time(6)
  created_at  DateTime? @default(now()) @db.Timestamp(6)
  updated_at  DateTime? @default(now()) @db.Timestamp(6)
  clinics     clinics?  @relation(fields: [clinic_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([clinic_id, day_of_week])
}

model clinic_doctors {
  id                    String                @id @db.Uuid
  clinic_id             String?               @db.Uuid
  user_id               String?               @db.Uuid
  email                 String                @db.VarChar(255)
  name                  String?               @db.VarChar(255)
  specialty             String?               @db.VarChar(255)
  office_number         String?               @db.VarChar(50)
  profile_image_url     String?               @db.VarChar(500)
  phone                 String?               @db.VarChar(20)
  whatsapp              String?               @db.VarChar(20)
  is_active             Boolean?              @default(true)
  is_invited            Boolean?              @default(true)
  invitation_token      String?               @unique @db.VarChar(255)
  invitation_expires_at DateTime?             @db.Timestamp(6)
  created_at            DateTime?             @default(now()) @db.Timestamp(6)
  updated_at            DateTime?             @default(now()) @db.Timestamp(6)
  clinics               clinics?              @relation(fields: [clinic_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users                 users?                @relation(fields: [user_id], references: [id], onUpdate: NoAction)
  doctor_schedules      doctor_schedules[]
  reception_messages    reception_messages[]
  date_block_requests   date_block_requests[]

  @@unique([clinic_id, email])
}

model reception_messages {
  id             String          @id @db.Uuid
  clinic_id      String?         @db.Uuid
  doctor_id      String?         @db.Uuid
  message        String
  sender_type    String          @db.VarChar(50)
  is_read        Boolean?        @default(false)
  created_at     DateTime?       @default(now()) @db.Timestamp(6)
  clinics        clinics?        @relation(fields: [clinic_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  clinic_doctors clinic_doctors? @relation(fields: [doctor_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([clinic_id, doctor_id, created_at(sort: Desc)], map: "idx_reception_messages_clinic_doctor_created")
}

model date_block_requests {
  id             String          @id @db.Uuid
  clinic_id      String?         @db.Uuid
  doctor_id      String?         @db.Uuid
  date           DateTime        @db.Timestamp(6)
  reason         String?
  status         String          @default("pending") @db.VarChar(50)
  created_at     DateTime?       @default(now()) @db.Timestamp(6)
  updated_at     DateTime?       @default(now()) @db.Timestamp(6)
  clinics        clinics?        @relation(fields: [clinic_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  clinic_doctors clinic_doctors? @relation(fields: [doctor_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([clinic_id, doctor_id, date], map: "idx_date_block_requests_clinic_doctor_date")
}

model doctor_invitations {
  id               String    @id @db.Uuid
  clinic_id        String?   @db.Uuid
  email            String    @db.VarChar(255)
  invitation_token String    @unique @db.VarChar(255)
  expires_at       DateTime  @db.Timestamp(6)
  status           String?   @default("pending") @db.VarChar(50)
  created_at       DateTime? @default(now()) @db.Timestamp(6)
  clinics          clinics?  @relation(fields: [clinic_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model doctor_schedules {
  id             String          @id @db.Uuid
  doctor_id      String?         @db.Uuid
  clinic_id      String?         @db.Uuid
  day_of_week    Int
  enabled        Boolean?        @default(false)
  start_time     DateTime?       @db.Time(6)
  end_time       DateTime?       @db.Time(6)
  break_start    DateTime?       @db.Time(6)
  break_end      DateTime?       @db.Time(6)
  created_at     DateTime?       @default(now()) @db.Timestamp(6)
  updated_at     DateTime?       @default(now()) @db.Timestamp(6)
  clinics        clinics?        @relation(fields: [clinic_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  clinic_doctors clinic_doctors? @relation(fields: [doctor_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([doctor_id, clinic_id, day_of_week])
}

enum enum_appt_status {
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum enum_notif_types {
  REMINDER
  SYSTEM
  BOOKING
  cita
  laboratorio
  farmacia
  ambulancia
  insumo
  sistema
}

enum enum_roles {
  admin
  user
  provider
  patient
  pharmacy
  lab
  ambulance
  supplies
}

enum enum_verification {
  PENDING
  APPROVED
  REJECTED
}

enum enum_payment_method {
  CASH
  CARD
}

enum ad_status {
  PENDING
  APPROVED
  REJECTED
}

model pharmacy_chains {
  id         String      @id @db.Uuid
  name       String      @db.VarChar(255) @unique
  logo_url   String?     @db.Text // ⭐ Text para soportar base64
  description String?    @db.Text // ⭐ Descripción de la cadena
  is_active  Boolean?    @default(true)
  created_at DateTime?   @default(now()) @db.Timestamp(6)
  updated_at DateTime?   @default(now()) @db.Timestamp(6)
  providers  providers[] // ⭐ Relación con providers (farmacias)
}
